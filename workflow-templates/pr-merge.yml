name: PR Merge Workflow

on:
  push:
    branches:
      - main

permissions: read-all

env:
  notifications_slack_channel_id: C09C6TM2UQH # #delivery-test-notifications channel. Please update with desired channel.

jobs:
  tag:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: read
    outputs:
      semantic_tag: ${{ steps.tag.outputs.semantic_tag }}
    steps:
      - name: PaaPy Tag
        id: tag
        env:
          GH_TOKEN: ${{ github.token }}
        uses: humalytix/PaaPy-tag@v1

  build:
    needs: tag
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    outputs:
      ecr_repo_url: ${{ steps.build.outputs.ecr_repo_url }}
    steps:
      - name: Get PaaPy Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.PAAPY_APP_ID }}
          private-key: ${{ secrets.PAAPY_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: PaaPy Build
        id: build
        uses: humalytix/PaaPy-build@v1
        with:
          paapy_app_token: ${{ steps.app-token.outputs.token }}
          role_arn: ${{ vars.NONPROD_ROLE_ARN }}

  deploy-nonprod:
    needs: [tag, build]
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Get PaaPy Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.PAAPY_APP_ID }}
          private-key: ${{ secrets.PAAPY_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: PaaPy Deploy
        uses: humalytix/PaaPy-deploy-ecs@v1
        with:
          ecr_repo_url: ${{ needs.build.outputs.ecr_repo_url }}
          env: nonprod
          image_tag: ${{ needs.tag.outputs.semantic_tag }}
          paapy_app_token: ${{ steps.app-token.outputs.token }}
          role_arn: ${{ vars.NONPROD_ROLE_ARN }}

  # deploy-prod:
  #   needs: [tag, build, deploy-nonprod]
  #   runs-on: ubuntu-22.04
  #   permissions:
  #     id-token: write
  #     contents: read
  #   steps:
  #     - name: Get PaaPy Token
  #       uses: actions/create-github-app-token@v1
  #       id: app-token
  #       with:
  #         app-id: ${{ vars.PAAPY_APP_ID }}
  #         private-key: ${{ secrets.PAAPY_PRIVATE_KEY }}
  #         owner: ${{ github.repository_owner }}

  #     - name: PaaPy Deploy
  #       uses: humalytix/PaaPy-deploy-ecs@v1
  #       with:
  #         ecr_repo_url: ${{ needs.build.outputs.ecr_repo_url }}
  #         env: prod
  #         image_tag: ${{ needs.tag.outputs.semantic_tag }}
  #         paapy_app_token: ${{ steps.app-token.outputs.token }}
  #         role_arn: ${{ vars.PROD_ROLE_ARN }}

  notify-success:
    needs: [tag, build, deploy-nonprod] # add deploy-prod once in use
    runs-on: ubuntu-22.04
    steps:
      - name: Send Slack Message
        uses: humalytix/PaaPy-slack-notifications@v1
        with:
          header: Deployment Success!
          message: ${{ github.event.head_commit.message }}
          message_type: success
          slack_channel_id: ${{ env.notifications_slack_channel_id }}
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }} # inherits GH Org secret. Please overwrite with Repo Secret.

  notify-failure:
    needs: [tag, build, deploy-nonprod] # add deploy-prod once in use
    if: ${{ failure() }}
    runs-on: ubuntu-22.04
    steps:
      - name: Send Slack Message
        uses: humalytix/PaaPy-slack-notifications@v1
        with:
          header: Deployment Failure!
          message: ${{ github.event.head_commit.message }}
          message_type: failure
          slack_channel_id: ${{ env.notifications_slack_channel_id }}
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }} # inherits GH Org secret. Please overwrite with Repo Secret.

  notify-cancelled:
    needs: [tag, build, deploy-nonprod] # add deploy-prod once in use
    if: ${{ cancelled() }}
    runs-on: ubuntu-22.04
    steps:
      - name: Send Slack Message
        uses: humalytix/PaaPy-slack-notifications@v1
        with:
          header: Deployment Cancelled!
          message: ${{ github.event.head_commit.message }}
          message_type: cancelled
          slack_channel_id: ${{ env.notifications_slack_channel_id }}
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }} # inherits GH Org secret. Please overwrite with Repo Secret.
